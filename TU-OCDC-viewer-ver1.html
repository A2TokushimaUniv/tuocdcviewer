<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å¯¾è©±ã‚³ãƒ¼ãƒ‘ã‚¹ãƒ“ãƒ¥ãƒ¼ã‚¢(TU-OCDC Viewer)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: 2.2em;
        }
        
        .file-input-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .file-input {
            padding: 10px 15px;
            border: 2px dashed #2c5aa0;
            border-radius: 8px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sample-data-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        
        .sample-data-btn:hover {
            background: #218838;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .media-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .conversation-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .analysis-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 13px;
            color: #666;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #232738 0%, #46414f 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card_ang{
            background: linear-gradient(135deg, #c62828 0%, #e137bf 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card_sad{
            background: linear-gradient(135deg, #1805a4 0%, #3faff4 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-card_joy{
            background: linear-gradient(135deg, #009b3e 0%, #2cf630 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .russell-circle {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            position: relative;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                rgba(255,99,132,0.1) 0%, 
                rgba(255,206,84,0.1) 25%, 
                rgba(75,192,192,0.1) 50%, 
                rgba(153,102,255,0.1) 75%);
        }
        
        .russell-axis {
            position: absolute;
            background: #ccc;
        }
        
        .russell-axis.horizontal {
            width: 100%;
            height: 1px;
            top: 50%;
            left: 0;
        }
        
        .russell-axis.vertical {
            width: 1px;
            height: 100%;
            left: 50%;
            top: 0;
        }
        
        .russell-labels {
            position: absolute;
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        
        .russell-point {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .russell-point:hover {
            transform: translate(-50%, -50%) scale(1.5);
        }
        
        .russell-point.participant {
            background: #ff6b6b;
            border: 2px solid #fff;
        }
        
        .russell-point.counselor {
            background: #4ecdc4;
            border: 2px solid #fff;
        }
        
        .russell-point.active {
            transform: translate(-50%, -50%) scale(1.5);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.5);
        }
        
        /* é »å‡ºèªåˆ†æã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .word-analysis-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .morphology-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 11px;
            color: #1976d2;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .morphology-status.ready {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .morphology-status.loading {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }
        
        .morphology-toggle {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .morphology-toggle:hover {
            background: #1e3d6f;
        }
        
        .morphology-toggle.active {
            background: #28a745;
        }
        
        .speaker-filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .speaker-filter-btn {
            padding: 8px 16px;
            border: 2px solid #2c5aa0;
            background: white;
            color: #2c5aa0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: bold;
        }
        
        .speaker-filter-btn.active {
            background: #2c5aa0;
            color: white;
        }
        
        .word-count-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 80px;
        }
        
        .russell-word-plot {
            width: 400px;
            height: 400px;
            margin: 20px auto;
            position: relative;
            border: 2px solid #ddd;
            border-radius: 50%;
            background: linear-gradient(45deg, 
                rgba(255,99,132,0.05) 0%, 
                rgba(255,206,84,0.05) 25%, 
                rgba(75,192,192,0.05) 50%, 
                rgba(153,102,255,0.05) 75%);
        }
        
        .word-point {
            position: absolute;
            background: rgba(44, 90, 160, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .word-point:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .word-point.participant {
            background: rgba(255, 107, 107, 0.9);
        }
        
        .word-point.counselor {
            background: rgba(78, 205, 196, 0.9);
        }
        
        .word-point.both {
            background: linear-gradient(45deg, rgba(255, 107, 107, 0.9), rgba(78, 205, 196, 0.9));
        }
        
        .quadrant-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .quadrant-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            position: relative;
        }
        
        .quadrant-card.q1 {
            border-color: #ff6b6b;
        }
        
        .quadrant-card.q2 {
            border-color: #feca57;
        }
        
        .quadrant-card.q3 {
            border-color: #48dbfb;
        }
        
        .quadrant-card.q4 {
            border-color: #1dd1a1;
        }
        
        .quadrant-title {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .quadrant-title.q1 {
            color: #ff6b6b;
        }
        
        .quadrant-title.q2 {
            color: #feca57;
        }
        
        .quadrant-title.q3 {
            color: #48dbfb;
        }
        
        .quadrant-title.q4 {
            color: #1dd1a1;
        }
        
        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .word-chip {
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            border: 1px solid #e0e0e0;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-label {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }
        
        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .conversation-view {
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .message.participant {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .message.participant .message-avatar {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .message.counselor .message-avatar {
            background: linear-gradient(135deg, #4ecdc4, #00b894);
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message.participant .message-content {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.counselor .message-content {
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .message-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .message-text {
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .message-meta {
            font-size: 11px;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .message-time {
            font-family: monospace;
        }
        
        .message-scores {
            display: flex;
            gap: 8px;
        }
        
        .score-chip {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        .message.counselor .score-chip {
            background: rgba(0,0,0,0.1);
        }
        
        .message.active {
            background: rgba(44, 90, 160, 0.1);
            border-radius: 10px;
            padding: 5px;
        }
        
        .search-highlight {
            background: yellow;
            padding: 1px 3px;
            border-radius: 3px;
        }
        
        .media-player {
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .media-player video {
            width: 100%;
            height: auto;
            min-height: 200px;
            max-height: 300px;
            display: block;
            background: #000;
        }
        
        .media-player audio {
            width: 100%;
            height: 60px;
            display: block;
            margin-top: 10px;
        }
        
        .media-controls {
            background: #2c5aa0;
            color: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 12px;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .control-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
        }
        
        .control-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .media-type-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .media-type-btn.active {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .time-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .progress-indicator {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            height: 100%;
            background: #2c5aa0;
            transition: width 0.1s ease;
        }
        
        .info-section {
            background: #f8f9ff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .info-section h3 {
            color: #2c5aa0;
            margin-bottom: 8px;
            font-size: 1em;
        }
        
        .info-item {
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .info-label {
            font-weight: bold;
            color: #666;
        }
        
        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 1.1em;
        }
        
        .loading-indicator {
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .error-message {
            color: #ff6b6b;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .segment-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(44, 90, 160, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .clickable-point {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .clickable-point:hover {
            transform: scale(1.2);
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .conversation-section {
                order: 2;
            }
            
            .russell-circle, .russell-word-plot {
                width: 250px;
                height: 250px;
            }
        }
        
        /* è¡¨æƒ…åˆ†æé–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .face-analysis-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .face-status {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 11px;
            color: #1976d2;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .face-status.loaded {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .face-status.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        .face-status.no-data {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }
        
        .face-visualization {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .chart-section h4 {
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .au-heatmap-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        
        .au-heatmap-section h4 {
            color: #2c5aa0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .au-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .au-cell {
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .au-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .au-name {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }
        
        .au-value {
            font-size: 14px;
            font-weight: bold;
            color: #2c5aa0;
        }
        
        .emotion-radar {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .face-analysis-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .au-heatmap {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filters, .word-analysis-controls {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .tabs {
                justify-content: flex-start;
                overflow-x: auto;
            }
            
            .quadrant-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ å¾³å³¶å¤§å­¦ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚«ã‚¦ãƒ³ã‚»ãƒªãƒ³ã‚°å¯¾è©±ã‚³ãƒ¼ãƒ‘ã‚¹ï¼ˆTU-OCDCï¼‰</h1>
            <div class="file-input-section">
                <input type="file" id="fileInput" accept=".jsonl" class="file-input" />
                <button class="sample-data-btn" id="sampleDataBtn">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            </div>
            <p>JSONLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§é«˜åº¦ãªåˆ†ææ©Ÿèƒ½ã‚’ä½“é¨“ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
        
        <div class="main-layout">
            <div class="media-section">
                <div class="info-section">
                    <h3>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±</h3>
                    <div class="info-item">
                        <span class="info-label">ID:</span>
                        <span id="fileId">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°:</span>
                        <span id="segmentCount">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ:</span>
                        <span id="currentSegmentInfo">-</span>
                    </div>
                </div>
                
                <div class="media-player" id="mediaPlayer">
                    <div class="no-data">
                        ğŸ“ JSONLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
                    </div>
                </div>
                
                <div class="media-controls">
                    <div style="display: flex; gap: 10px;">
                        <button class="media-type-btn" id="videoBtn">ğŸ“¹ å‹•ç”»</button>
                        <button class="media-type-btn active" id="audioBtn">ğŸµ éŸ³å£°</button>
                    </div>
                    <button class="control-btn" id="playPauseBtn" disabled>â–¶ï¸ å†ç”Ÿ</button>
                    <button class="control-btn" id="prevBtn" disabled>â®ï¸ å‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</button>
                    <button class="control-btn" id="nextBtn" disabled>â­ï¸ æ¬¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ</button>
                    <button class="control-btn" id="playCurrentBtn" disabled>ğŸ¯ ç¾åœ¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ</button>
                    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
                    <div class="progress-indicator">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
            
            <div class="conversation-section">
                <h3 style="color: #2c5aa0; margin-bottom: 20px;">ğŸ’¬ ä¼šè©±ãƒ“ãƒ¥ãƒ¼</h3>
                
                <div class="filters">
                    <div class="filter-group">
                        <div class="filter-label">è©±è€…</div>
                        <select class="filter-select" id="speakerFilter">
                            <option value="">å…¨ã¦</option>
                            <option value="participant">å‚åŠ è€…</option>
                            <option value="counselor">ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">æ„Ÿæƒ…</div>
                        <select class="filter-select" id="emotionFilter">
                            <option value="">å…¨ã¦</option>
                            <option value="å¹³é™">å¹³é™</option>
                            <option value="å¹¸ç¦">å¹¸ç¦</option>
                            <option value="æ˜ã‚‹ã„">æ˜ã‚‹ã„</option>
                            <option value="èˆˆå¥®">èˆˆå¥®</option>
                            <option value="é©šã">é©šã</option>
                            <option value="è­¦æˆ’">è­¦æˆ’</option>
                            <option value="æã‚Œ">æã‚Œ</option>
                            <option value="æ‚©ã¿">æ‚©ã¿</option>
                            <option value="ä¸æ„‰å¿«">ä¸æ„‰å¿«</option>
                            <option value="æŠ‘åœ§">æŠ‘åœ§</option>
                            <option value="æ†‚é¬±">æ†‚é¬±</option>
                            <option value="é€€å±ˆ">é€€å±ˆ</option>
                            <option value="ç–²ã‚Œ">ç–²ã‚Œ</option>
                            <option value="çœ æ°—">çœ æ°—</option>
                            <option value="ãƒªãƒ©ãƒƒã‚¯ã‚¹">ãƒªãƒ©ãƒƒã‚¯ã‚¹</option>
                            <option value="æ°—æ¥½">æ°—æ¥½</option>
                            <option value="æº€è¶³">æº€è¶³</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <div class="filter-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</div>
                        <input type="text" class="filter-input" id="keywordSearch" placeholder="ç™ºè©±å†…å®¹ã‚’æ¤œç´¢...">
                    </div>
                
                </div>
                
                <div class="conversation-view" id="conversationView">
                    <div class="no-data">ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">ğŸ“Š æ¦‚è¦</button>
                <button class="tab" onclick="switchTab('russell')">ğŸ¯ Russell</button>
                <button class="tab" onclick="switchTab('trends')">ğŸ“ˆ æ¨ç§»</button>
                <button class="tab" onclick="switchTab('words')">ğŸ“ é »å‡ºèª</button>
                <button class="tab" onclick="switchTab('face')">ğŸ­ æ„Ÿæƒ…åˆ†æ</button>
            </div>
            
            <div id="overview-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡è¦šé†’åº¦</div>
                        <div class="stat-value" id="avgArousal">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡æ„Ÿæƒ…ä¾¡</div>
                        <div class="stat-value" id="avgValence">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡ã‚¹ãƒˆãƒ¬ã‚¹</div>
                        <div class="stat-value" id="avgStress">-</div>
                    </div>
                    <div class="stat-card_sad">
                        <div class="stat-label">éŸ³å£°æ„Ÿæƒ…ï¼ˆæ‚²ã—ã¿ï¼‰</div>
                        <div class="stat-value" id="avgAudioSad">-</div>
                    </div>
                    <div class="stat-card_joy">
                        <div class="stat-label">éŸ³å£°æ„Ÿæƒ…ï¼ˆå–œã³ï¼‰</div>
                        <div class="stat-value" id="avgAudioHap">-</div>
                    </div>
                    <div class="stat-card_ang">
                        <div class="stat-label">éŸ³å£°æ„Ÿæƒ…ï¼ˆæ€’ã‚Šï¼‰</div>
                        <div class="stat-value" id="avgAudioAng">-</div>
                    </div>
                    <div class="stat-card_sad">
                        <div class="stat-label">ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ï¼ˆæ‚²ã—ã¿ï¼‰</div>
                        <div class="stat-value" id="avgTextSad">-</div>
                    </div>
                    <div class="stat-card_joy">
                        <div class="stat-label">ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ï¼ˆå–œã³ï¼‰</div>
                        <div class="stat-value" id="avgTextJoy">-</div>
                    </div>
                    <div class="stat-card_ang">
                        <div class="stat-label">ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ï¼ˆæ€’ã‚Šï¼‰</div>
                        <div class="stat-value" id="avgTextAnger">-</div>
                    </div>

                    <div class="stat-card_sad">
                        <div class="stat-label">è¡¨æƒ…ï¼ˆæ‚²ã—ã¿ï¼‰</div>
                        <div class="stat-value" id="avgFaceSad">-</div>
                    </div>
                    <div class="stat-card_joy">
                        <div class="stat-label">è¡¨æƒ…ï¼ˆå–œã³ï¼‰</div>
                        <div class="stat-value" id="avgFaceHap">-</div>
                    </div>
                    <div class="stat-card_ang">
                        <div class="stat-label">è¡¨æƒ…ï¼ˆæ€’ã‚Šï¼‰</div>
                        <div class="stat-value" id="avgFaceAnger">-</div>
                    </div>
                </div>
            </div>
            
            <div id="russell-tab" class="tab-content">
                <div class="russell-circle" id="russellCircle">
                    <div class="russell-axis horizontal"></div>
                    <div class="russell-axis vertical"></div>
                    <div class="russell-labels" style="top: 10px; left: 50%; transform: translateX(-50%);">é«˜è¦šé†’</div>
                    <div class="russell-labels" style="bottom: 10px; left: 50%; transform: translateX(-50%);">ä½è¦šé†’</div>
                    <div class="russell-labels" style="left: 10px; top: 50%; transform: translateY(-50%);">ä¸å¿«</div>
                    <div class="russell-labels" style="right: 10px; top: 50%; transform: translateY(-50%);">å¿«</div>
                </div>
            </div>
            
            <div id="trends-tab" class="tab-content">
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>
            
            <div id="words-tab" class="tab-content">
                <div class="word-analysis-controls">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 12px; font-weight: bold;">åˆ†æå¯¾è±¡:</span>
                        <span style="background: #2c5aa0; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            å‚åŠ è€…ã®ã¿
                        </span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="font-size: 12px; font-weight: bold;">è¡¨ç¤ºå˜èªæ•°:</span>
                        <input type="number" class="word-count-input" id="wordCountInput" value="20" min="5" max="50">
                    </div>
                    <div class="morphology-status" id="morphologyStatus">
                        <span>ğŸ”§ å½¢æ…‹ç´ è§£æ: åˆæœŸåŒ–ä¸­...</span>
                    </div>
                    <button class="morphology-toggle" id="morphologyToggle" title="å½¢æ…‹ç´ è§£æã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ">
                        å½¢æ…‹ç´ è§£æ: OFF
                    </button>
                </div>
                
                <div class="russell-word-plot" id="russellWordPlot">
                    <div class="russell-axis horizontal"></div>
                    <div class="russell-axis vertical"></div>
                    <div class="russell-labels" style="top: 10px; left: 50%; transform: translateX(-50%);">é«˜è¦šé†’</div>
                    <div class="russell-labels" style="bottom: 10px; left: 50%; transform: translateX(-50%);">ä½è¦šé†’</div>
                    <div class="russell-labels" style="left: 10px; top: 50%; transform: translateY(-50%);">ä¸å¿«</div>
                    <div class="russell-labels" style="right: 10px; top: 50%; transform: translateY(-50%);">å¿«</div>
                </div>
                
                <div class="quadrant-stats">
                    <div class="quadrant-card q2">
                        <div class="quadrant-title q2">ç¬¬2è±¡é™ (é«˜è¦šé†’ãƒ»ä¸å¿«)</div>
                        <div class="word-list" id="q2Words"></div>
                    </div>
                    <div class="quadrant-card q1">
                        <div class="quadrant-title q1">ç¬¬1è±¡é™ (é«˜è¦šé†’ãƒ»å¿«)</div>
                        <div class="word-list" id="q1Words"></div>
                    </div>
                    <div class="quadrant-card q3">
                        <div class="quadrant-title q3">ç¬¬3è±¡é™ (ä½è¦šé†’ãƒ»ä¸å¿«)</div>
                        <div class="word-list" id="q3Words"></div>
                    </div>
                    <div class="quadrant-card q4">
                        <div class="quadrant-title q4">ç¬¬4è±¡é™ (ä½è¦šé†’ãƒ»å¿«)</div>
                        <div class="word-list" id="q4Words"></div>
                    </div>
                </div>
            </div>
            
            <div id="face-tab" class="tab-content">
                <div class="face-analysis-controls">
                    <div class="face-status" id="faceStatus">
                        <span>ğŸ­ æ„Ÿæƒ…åˆ†æãƒ‡ãƒ¼ã‚¿: æœªèª­ã¿è¾¼ã¿</span>
                    </div>
                </div>
                
                <div class="face-visualization" id="faceVisualization">
                    <div class="no-data">JSONLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ„Ÿæƒ…åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™</div>
                </div>
                
                <div class="face-charts" id="faceCharts" style="display: none;">
                    <div class="chart-section">
                        <h4>ğŸ­ é¡”é¢æ„Ÿæƒ…è¡¨ç¾ (7ã¤ã®åŸºæœ¬æ„Ÿæƒ…)</h4>
                        <div class="chart-container">
                            <canvas id="faceEmotionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h4>ğŸµ éŸ³å£°æ„Ÿæƒ…åˆ†æ</h4>
                        <div class="chart-container">
                            <canvas id="audioEmotionChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h4>ğŸ—’ï¸ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…åˆ†æï¼ˆï¼˜æ„Ÿæƒ…ï¼‰</h4>
                        <div class="chart-container">
                            <canvas id="textEmotionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-section">
                        <h4>ğŸ—’ï¸ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…åˆ†æ(æ„Ÿæƒ…æ¥µæ€§å€¤)</h4>
                        <div class="chart-container">
                            <canvas id="textSentimentChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h4>ğŸ§­ é¡”ã®å‘ã (Pitch, Roll, Yaw)</h4>
                        <div class="chart-container">
                            <canvas id="headPoseChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-section">
                        <h4>ğŸ’ª ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆ (ä¸Šä½10å€‹)</h4>
                        <div class="chart-container">
                            <canvas id="actionUnitChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="au-heatmap-section">
                        <h4>ğŸ”¥ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h4>
                        <div class="au-heatmap" id="auHeatmap"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentData = null;
        let currentVideoElement = null;
        let currentAudioElement = null;
        let currentSegmentIndex = 0;
        let isPlaying = false;
        let segments = [];
        let filteredSegments = [];
        let segmentMapping = []; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        let currentMediaMode = 'audio'; // video, audio
        let mediaFiles = { video: null, audio: null };
        let trendsChart = null;
        let segmentPlaybackTimeout = null;

        // è¡¨æƒ…åˆ†æé–¢é€£å¤‰æ•°
        let faceAnalysisData = [];
        let faceEmotionChart = null;
        let audioEmotionChart = null;
        let textEmotionChart = null;
        let textSentimentChart = null;
        let headPoseChart = null;
        let actionUnitChart = null;
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆã®åå‰ãƒãƒƒãƒ”ãƒ³ã‚°
        const actionUnitNames = {
            'AU01': 'ã‚¤ãƒ³ãƒŠãƒ¼çœ‰ä¸Šã’',
            'AU02': 'ã‚¢ã‚¦ã‚¿ãƒ¼çœ‰ä¸Šã’',
            'AU04': 'çœ‰å¯„ã›',
            'AU05': 'ä¸Šã¾ã¶ãŸä¸Šã’',
            'AU06': 'é ¬ä¸Šã’',
            'AU07': 'ã¾ã¶ãŸç· ã‚',
            'AU09': 'é¼»ã—ã‚å¯„ã›',
            'AU10': 'ä¸Šå”‡ä¸Šã’',
            'AU11': 'å£è§’æºæ·±ã‚',
            'AU12': 'å£è§’ä¸Šã’',
            'AU14': 'ãˆãã¼',
            'AU15': 'å£è§’ä¸‹ã’',
            'AU17': 'ã‚ã”ä¸Šã’',
            'AU20': 'å£è§’æ¨ªæ‹¡å¼µ',
            'AU23': 'å”‡ç· ã‚',
            'AU24': 'å”‡ã™ã¼ã‚',
            'AU25': 'å”‡åˆ†é›¢',
            'AU26': 'é¡ä¸‹ã’',
            'AU28': 'å”‡å¸è¾¼ã¿',
            'AU43': 'ç›®é–‰ã˜'
        };
        
        // æ„Ÿæƒ…ã®æ—¥æœ¬èªåãƒãƒƒãƒ”ãƒ³ã‚°
        const emotionNames = {
            'anger': 'æ€’ã‚Š',
            'disgust': 'å«Œæ‚ª',
            'fear': 'ææ€–',
            'happiness': 'å¹¸ç¦',
            'sadness': 'æ‚²ã—ã¿',
            'surprise': 'é©šã',
            'neutral': 'ä¸­æ€§'
        };

        // éŸ³å£°æ„Ÿæƒ…ã®æ—¥æœ¬èªåãƒãƒƒãƒ”ãƒ³ã‚°
        const audioEmotionNames = {
            'angry': 'æ€’ã‚Š',
            'happy': 'å¹¸ç¦',
            'sad': 'æ‚²ã—ã¿',
            'neutral': 'ä¸­æ€§'
        };
        // ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ã®æ—¥æœ¬èªåãƒãƒƒãƒ”ãƒ³ã‚°
        const textEmotionNames = {
            'joy': 'å–œã³',
            'sadness': 'æ‚²ã—ã¿',
            'anticipation': 'æœŸå¾…',
            'surprise': 'é©šã',
            'anger': 'æ€’ã‚Š',
            'fear': 'æã‚Œ',
            'disgust': 'å«Œæ‚ª',
            'trust': 'ä¿¡é ¼'
        };

        // è¡¨æƒ…åˆ†æãƒ‡ãƒ¼ã‚¿å‡¦ç†
        function processFaceAnalysisData() {
            console.log('=== è¡¨æƒ…åˆ†æãƒ‡ãƒ¼ã‚¿å‡¦ç†é–‹å§‹ ===');
            
            faceAnalysisData = [];
            let hasValidData = false;
            
            segments.forEach((segment, index) => {
                const faceData = {
                    segmentIndex: index,
                    timestamp: segment.start,
                    speaker: segment.speaker,
                    // éŸ³å£°æ„Ÿæƒ…
                    audioEmotions: {},
                    // ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…
                    textEmotions: {},
                    // ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¸ãƒã‚¬
                    textSentiment: 0,

                    // é¡”é¢æ„Ÿæƒ…
                    faceEmotions: {},

                    // é¡”ã®å‘ã
                    headPose: {},
                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆ
                    actionUnits: {}
                };
                
                // éŸ³å£°æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®è§£æ
                if (segment.audio_emotion) {
                    try {
                        const audioEmotions = segment.audio_emotion.split(' ');
                        audioEmotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion && value !== undefined) {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    faceData.audioEmotions[emotion] = numValue;
                                    hasValidData = true;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('éŸ³å£°æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.audio_emotion);
                    }
                }
                // è¨€èªæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®è§£æ
                if (segment.text_emotion) {
                    try {
                        const textEmotions = segment.text_emotion.split(' ');
                        textEmotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion && value !== undefined && value !== 'nan') {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    faceData.textEmotions[emotion] = numValue;
                                    hasValidData = true;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.text_emotion);
                    }
                }
                // è¨€èªæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿(posi-nega)ã®è§£æ
                if (segment.text_sentiment) {
                    try {
                        const textSentiment = segment.text_sentiment;
                        const numValue = parseFloat(textSentiment);
                        if (!isNaN(numValue)){
                            faceData.textSentiment = numValue;
                            hasValidData = true;
                        }
                    } catch (error) {
                        console.warn('ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¸ãƒã‚¬æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.text_sentiment);
                    }
                }

                // é¡”é¢æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ã®è§£æ
                if (segment.face_emotion) {
                    try {
                        const faceEmotions = segment.face_emotion.split(' ');
                        faceEmotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion && value !== undefined && value !== 'nan') {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    faceData.faceEmotions[emotion] = numValue;
                                    hasValidData = true;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('é¡”é¢æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.face_emotion);
                    }
                }
                
                // é¡”ã®å‘ããƒ‡ãƒ¼ã‚¿ã®è§£æ
                if (segment.pitch_roll_yaw) {
                    try {
                        const poseData = segment.pitch_roll_yaw.split(' ');
                        poseData.forEach(poseStr => {
                            const [axis, value] = poseStr.split(':');
                            if (axis && value !== undefined && value !== 'nan') {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    faceData.headPose[axis] = numValue;
                                    hasValidData = true;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('é¡”ã®å‘ããƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.pitch_roll_yaw);
                    }
                }
                
                // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®è§£æ
                if (segment.AU) {
                    try {
                        const auData = segment.AU.split(' ');
                        auData.forEach(auStr => {
                            const [au, value] = auStr.split(':');
                            if (au && value !== undefined && value !== 'nan') {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    faceData.actionUnits[au] = numValue;
                                    hasValidData = true;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error, segment.AU);
                    }
                }
                
                faceAnalysisData.push(faceData);
            });
            
            console.log('æ„Ÿæƒ…åˆ†æãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†:', faceAnalysisData.length, 'ä»¶');
            console.log('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿:', hasValidData);
            
            if (hasValidData) {
                updateFaceStatus('loaded', `âœ… è¡¨æƒ…åˆ†æãƒ‡ãƒ¼ã‚¿: ${faceAnalysisData.length}ä»¶å‡¦ç†å®Œäº†`);
                displayFaceVisualization();
            } else {
                updateFaceStatus('no-data', 'âš ï¸ è¡¨æƒ…åˆ†æãƒ‡ãƒ¼ã‚¿: æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }
        
        // è¡¨æƒ…åˆ†æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateFaceStatus(status, message) {
            const statusElement = document.getElementById('faceStatus');
            statusElement.textContent = message;
            statusElement.className = `face-status ${status}`;
        }
        
        // è¡¨æƒ…åˆ†æå¯è¦–åŒ–è¡¨ç¤º
        function displayFaceVisualization() {
            console.log('=== è¡¨æƒ…åˆ†æå¯è¦–åŒ–è¡¨ç¤ºé–‹å§‹ ===');
            
            document.getElementById('faceVisualization').style.display = 'none';
            document.getElementById('faceCharts').style.display = 'block';
            
            createFaceEmotionChart();
            createAudioEmotionChart();
            createTextEmotionChart();
            createTextSentimentChart();
            createHeadPoseChart();
            createActionUnitChart();
            createAUHeatmap();
        }
        
        // é¡”é¢æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createFaceEmotionChart() {
            console.log('=== é¡”é¢æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            
            const ctx = document.getElementById('faceEmotionChart').getContext('2d');
            
            if (faceEmotionChart) {
                faceEmotionChart.destroy();
            }
            
            const emotions = ['anger', 'disgust', 'fear', 'happiness', 'sadness', 'surprise', 'neutral'];
            const colors = ['#ff6b6b', '#8e44ad', '#34495e', '#f1c40f', '#3498db', '#e67e22', '#95a5a6'];
            
            const datasets = emotions.map((emotion, index) => ({
                label: emotionNames[emotion],
                data: faceAnalysisData.map(row => row.faceEmotions[emotion] || 0),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6
            }));
            
            faceEmotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æ„Ÿæƒ…å¼·åº¦'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            });
        }
        
        // éŸ³å£°æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createAudioEmotionChart() {
            console.log('=== éŸ³å£°æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            
            const ctx = document.getElementById('audioEmotionChart').getContext('2d');
            
            if (audioEmotionChart) {
                audioEmotionChart.destroy();
            }
            
            const emotions = ['angry', 'happy', 'sad', 'neutral'];
            const colors = ['#ff6b6b', '#f1c40f', '#3498db', '#95a5a6'];
            
            const datasets = emotions.map((emotion, index) => ({
                label: audioEmotionNames[emotion],
                data: faceAnalysisData.map(row => row.audioEmotions[emotion] || 0),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6
            }));
            
            audioEmotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æ„Ÿæƒ…å¼·åº¦'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createTextEmotionChart() {
            console.log('=== ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            
            const ctx = document.getElementById('textEmotionChart').getContext('2d');
            
            if (textEmotionChart) {
                textEmotionChart.destroy();
            }
            
            const emotions = ['joy', 'sadness', 'anticipation', 'surprise','anger', 'fear', 'disgust', 'trust'];
            //const colors = ['#ff6b6b', '#f1c40f', '#3498db', '#95a5a6'];
            const colors = [
                            '#ff6b6b', // joy (å–œã³)
                            '#4a90e2', // sadness (æ‚²ã—ã¿)
                            '#f39c12', // anticipation (æœŸå¾…)
                            '#f1c40f', // surprise (é©šã)
                            '#e74c3c', // anger (æ€’ã‚Š)
                            '#8e44ad', // fear (æã‚Œ)
                            '#2ecc71', // disgust (å«Œæ‚ª)
                            '#3498db'  // trust (ä¿¡é ¼)
                            ];
            
            const datasets = emotions.map((emotion, index) => ({
                label: textEmotionNames[emotion],
                data: faceAnalysisData.map(row => row.textEmotions[emotion] || 0),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6
            }));
            
            textEmotionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æ„Ÿæƒ…å¼·åº¦'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            });
        }


        // ãƒ†ã‚­ã‚¹ãƒˆpojinegaæ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createTextSentimentChart() {
            console.log('=== ãƒ†ã‚­ã‚¹ãƒˆPosi-Nega-æ„Ÿæƒ…ãƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            const ctx = document.getElementById('textSentimentChart').getContext('2d');
            
            if (textSentimentChart) {
                textSentimentChart.destroy();
            }
           const emotions = ['sentiment']//, 'sadness', 'anticipation', 'surprise','anger', 'fear', 'disgust', 'trust'];
            //const colors = ['#ff6b6b', '#f1c40f', '#3498db', '#95a5a6'];
            const colors = [
                            //'#ff6b6b', // joy (å–œã³)
                            //'#4a90e2', // sadness (æ‚²ã—ã¿)
                            //'#f39c12', // anticipation (æœŸå¾…)
                            //'#f1c40f', // surprise (é©šã)
                            //'#e74c3c', // anger (æ€’ã‚Š)
                            //'#8e44ad', // fear (æã‚Œ)
                            //'#2ecc71', // disgust (å«Œæ‚ª)
                            '#3498db'  // trust (ä¿¡é ¼)
                            ];
            
            const datasets = emotions.map((emotion, index) => ({
                label: 'sentiment',
                data: faceAnalysisData.map(row => row.textSentiment || 0),
                borderColor: colors[0], //index],
                backgroundColor: colors[0] + '20', //index] + '20',
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6
            }));
            
            textSentimentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'æ„Ÿæƒ…å¼·åº¦'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            }); 
           
        }

        
        // é¡”ã®å‘ããƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createHeadPoseChart() {
            console.log('=== é¡”ã®å‘ããƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            
            const ctx = document.getElementById('headPoseChart').getContext('2d');
            
            if (headPoseChart) {
                headPoseChart.destroy();
            }
            
            headPoseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: [
                        {
                            label: 'Pitch (ä¸Šä¸‹)',
                            data: faceAnalysisData.map(row => row.headPose.Pitch || null),
                            borderColor: '#e74c3c',
                            backgroundColor: '#e74c3c20',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Roll (å‚¾ã)',
                            data: faceAnalysisData.map(row => row.headPose.Roll || null),
                            borderColor: '#2ecc71',
                            backgroundColor: '#2ecc7120',
                            tension: 0.4,
                            spanGaps: true
                        },
                        {
                            label: 'Yaw (å·¦å³)',
                            data: faceAnalysisData.map(row => row.headPose.Yaw || null),
                            borderColor: '#3498db',
                            backgroundColor: '#3498db20',
                            tension: 0.4,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'è§’åº¦ (åº¦)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            });
        }
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆãƒãƒ£ãƒ¼ãƒˆä½œæˆ
        function createActionUnitChart() {
            console.log('=== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆãƒãƒ£ãƒ¼ãƒˆä½œæˆ ===');
            
            const ctx = document.getElementById('actionUnitChart').getContext('2d');
            
            if (actionUnitChart) {
                actionUnitChart.destroy();
            }
            
            // å„AUã®å¹³å‡å€¤ã‚’è¨ˆç®—ã—ã¦ä¸Šä½10å€‹ã‚’é¸æŠ
            const auKeys = Object.keys(actionUnitNames);
            const auAverages = auKeys.map(au => {
                const validValues = faceAnalysisData
                    .map(row => row.actionUnits[au])
                    .filter(val => val !== undefined && !isNaN(val));
                
                const average = validValues.length > 0 ? 
                    validValues.reduce((sum, val) => sum + val, 0) / validValues.length : 0;
                
                return {
                    au: au,
                    average: average,
                    name: actionUnitNames[au],
                    count: validValues.length
                };
            }).filter(item => item.count > 0)
              .sort((a, b) => b.average - a.average)
              .slice(0, 10);
            
            const colors = [
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'
            ];
            
            const datasets = auAverages.map((item, index) => ({
                label: `${item.au} (${item.name})`,
                data: faceAnalysisData.map(row => row.actionUnits[item.au] || null),
                borderColor: colors[index],
                backgroundColor: colors[index] + '20',
                tension: 0.4,
                pointRadius: 2,
                pointHoverRadius: 5,
                spanGaps: true
            }));
            
            actionUnitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: faceAnalysisData.map((_, index) => `${index + 1}`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: 'AUå¼·åº¦'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ'
                            }
                        }
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            jumpToSegment(index);
                        }
                    }
                }
            });
        }
        
        // AUãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½œæˆ
        function createAUHeatmap() {
            console.log('=== AUãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ä½œæˆ ===');
            
            const heatmapContainer = document.getElementById('auHeatmap');
            heatmapContainer.innerHTML = '';
            
            const auKeys = Object.keys(actionUnitNames);
            
            auKeys.forEach(au => {
                const validValues = faceAnalysisData
                    .map(row => row.actionUnits[au])
                    .filter(val => val !== undefined && !isNaN(val));
                
                if (validValues.length === 0) return;
                
                const average = validValues.reduce((sum, val) => sum + val, 0) / validValues.length;
                const max = Math.max(...validValues);
                
                const cell = document.createElement('div');
                cell.className = 'au-cell';
                
                // å¼·åº¦ã«å¿œã˜ã¦èƒŒæ™¯è‰²ã‚’è¨­å®š
                const intensity = average;
                const hue = (1 - intensity) * 120; // ç·‘(120)ã‹ã‚‰èµ¤(0)ã¸
                cell.style.background = `linear-gradient(135deg, hsl(${hue}, 70%, 85%), hsl(${hue}, 70%, 95%))`;
                cell.style.borderColor = `hsl(${hue}, 70%, 60%)`;
                
                cell.innerHTML = `
                    <div class="au-name">${au}</div>
                    <div class="au-name" style="font-size: 10px;">${actionUnitNames[au]}</div>
                    <div class="au-value">${average.toFixed(3)}</div>
                    <div style="font-size: 10px; color: #666;">æœ€å¤§: ${max.toFixed(3)}</div>
                    <div style="font-size: 9px; color: #999;">ã‚µãƒ³ãƒ—ãƒ«æ•°: ${validValues.length}</div>
                `;
                
                cell.title = `${au} (${actionUnitNames[au]})\nå¹³å‡: ${average.toFixed(3)}\næœ€å¤§: ${max.toFixed(3)}\nã‚µãƒ³ãƒ—ãƒ«æ•°: ${validValues.length}`;
                
                heatmapContainer.appendChild(cell);
            });
        }

        // æ—¥æœ¬èªã‚¹ãƒˆãƒƒãƒ—ãƒ¯ãƒ¼ãƒ‰
        const japaneseStopwords = new Set([
            'ã®', 'ã«', 'ã¯', 'ã‚’', 'ãŒ', 'ã§', 'ã¨', 'ã¦', 'ã‚‚', 'ã ', 'ã§ã‚ã‚‹', 'ã§ã™', 'ã¾ã™', 'ã—ãŸ', 'ã—ã¦', 'ã™ã‚‹', 'ã‚ã‚‹', 'ã„ã‚‹', 'ãªã‚‹', 'ã‚‰ã‚Œã‚‹', 'ã‚Œã‚‹', 'ã›ã‚‹', 'ã•ã›ã‚‹',
            'ã“ã¨', 'ã‚‚ã®', 'ãŸã‚', 'ã‚ˆã†', 'ãªã©', 'ãã‚Œ', 'ã“ã‚Œ', 'ã‚ã‚Œ', 'ãã®', 'ã“ã®', 'ã‚ã®', 'ã©ã®', 'ã¨ã„ã†', 'ã¨ã„ã£ãŸ', 'ã¨ã—ã¦', 'ã«ã¤ã„ã¦', 'ã«ã‚ˆã‚Š', 'ã«ã‚ˆã‚‹', 'ã‹ã‚‰', 'ã¾ã§', 'ã‚ˆã‚Š', 'ã§ã¯', 'ã§ã‚‚', 'ã—ã‹ã—', 'ã‘ã‚Œã©', 'ã‘ã‚Œã©ã‚‚', 'ã ã‹ã‚‰', 'ãã—ã¦', 'ã¾ãŸ', 'ã•ã‚‰ã«', 'ãŸã ã—', 'ãªãŠ', 'ã¾ãŸ', 'ãã“ã§', 'ã¨ã“ã‚ã§', 'ã¡ãªã¿ã«', 'ã¤ã¾ã‚Š', 'ã™ãªã‚ã¡', 'ã—ãŸãŒã£ã¦', 'ã‚†ãˆã«', 'ãªãœãªã‚‰', 'ã¨ã„ã†ã®ã¯', 'ãªãœãªã‚‰ã°',
            'ã¯ã„', 'ã„ã„ãˆ', 'ãˆãˆ', 'ã†ã‚“', 'ãã†', 'ãã†ã§ã™ã­', 'ãã†ã§ã™ã‹', 'ã‚ãƒ¼', 'ã†ãƒ¼ã‚“', 'ãˆãƒ¼ã¨', 'ã‚ã®', 'ãã®', 'ã“ã®', 'ã©ã®', 'ã¯ãƒ¼', 'ã¸ãƒ¼', 'ã»ãƒ¼', 'ãµãƒ¼ã‚“', 'ã‚ã£', 'ãŠã£', 'ã†ã£', 'ãˆã£',
            'ç§', 'ã‚ãªãŸ', 'å½¼', 'å½¼å¥³', 'åƒ•', 'ä¿º', 'å›', 'ãŠå‰', 'è‡ªåˆ†', 'ã¿ã‚“ãª', 'çš†', 'äºº', 'æ–¹', 'è€…', 'èª°', 'ä½•', 'ã©ã“', 'ã„ã¤', 'ã©ã†', 'ãªãœ', 'ã©ã†ã—ã¦', 'ã©ã‚Œ', 'ã©ã¡ã‚‰', 'ã©ã£ã¡',
            'ã¡ã‚‡ã£ã¨', 'ã¨ã¦ã‚‚', 'ã™ã”ã', 'ã‹ãªã‚Š', 'ã ã„ã¶', 'ã‘ã£ã“ã†', 'ã‚ã‚Šã¨', 'ãã“ãã“', 'ã¾ã‚ã¾ã‚', 'ã¡ã‚ƒã‚“ã¨', 'ãã¡ã‚“ã¨', 'ã—ã£ã‹ã‚Š', 'ã°ã£ã¡ã‚Š', 'ã´ã£ãŸã‚Š', 'ã¡ã‚‡ã†ã©', 'ã¾ã•ã«', 'ãã£ã¨', 'ãŠãã‚‰ã', 'ãŸã¶ã‚“', 'ã‚‚ã—ã‹ã—ã¦', 'ã‚‚ã—ã‹ã™ã‚‹ã¨'
        ]);
        
        // é »å‡ºèªåˆ†æç”¨å¤‰æ•°ï¼ˆæ—©æœŸåˆæœŸåŒ–ï¼‰
        let wordFrequencyData = {};
        let morphologyTokenizer = null;
        let useMorphology = false;

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        function loadSampleData() {
            console.log('=== ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ ===');
            const sampleData = {
                "segments": [
                    {
                        "valence": 0.2,
                        "arousal": 0.3,
                        "speaker": "participant",
                        "emotion": "å¹³é™:0.8 æœŸå¾…:0.2",
                        "start": 11300,
                        "end": 14900,
                        "total_score": 95.0,
                        "avg_score": 1.67,
                        "file_id": "2301092100",
                        "text": "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼ç§ã®åå‰ã¯ã¨ãã½ã‚“ã§ã™ï¼ä»Šæ—¥ã¯ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚æ¥½ã—ã„ä¸€æ—¥ã«ãªã‚Šãã†ã§ã™ã­ã€‚",
                        "stress_score_avg": 2.5,
                        "audio_emotion": "angry:0.1 happy:0.8 sad:0.1 neutral:0.0",
                        "face_emotion": "anger:0.05 disgust:0.02 fear:0.03 happiness:0.85 sadness:0.03 surprise:0.02 neutral:0.0",
                        "pitch_roll_yaw": "Pitch:5.2 Roll:-2.1 Yaw:1.8",
                        "AU": "AU01:0.1 AU02:0.05 AU04:0.02 AU05:0.1 AU06:0.8 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.9 AU14:0.0 AU15:0.0 AU17:0.0 AU20:0.0 AU23:0.0 AU24:0.0 AU25:0.1 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": 0.0,
                        "arousal": 0.0,
                        "speaker": "counselor",
                        "emotion": "å¹³é™:1.0",
                        "start": 15000,
                        "end": 18500,
                        "total_score": null,
                        "avg_score": null,
                        "file_id": "2301092100",
                        "text": "ã“ã‚“ã«ã¡ã¯ã€ã¨ãã½ã‚“ã•ã‚“ã€‚ã“ã¡ã‚‰ã“ãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚ä»Šæ—¥ã¯ãŠç–²ã‚Œã•ã¾ã§ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ãŠè©±ã—ã¾ã—ã‚‡ã†ã€‚",
                        "stress_score_avg": null,
                        "audio_emotion": "angry:0.0 happy:0.6 sad:0.0 neutral:0.4",
                        "face_emotion": "anger:0.01 disgust:0.01 fear:0.01 happiness:0.5 sadness:0.01 surprise:0.01 neutral:0.45",
                        "pitch_roll_yaw": "Pitch:2.1 Roll:0.5 Yaw:-0.8",
                        "AU": "AU01:0.05 AU02:0.02 AU04:0.0 AU05:0.0 AU06:0.3 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.6 AU14:0.0 AU15:0.0 AU17:0.0 AU20:0.0 AU23:0.0 AU24:0.0 AU25:0.05 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": 0.6,
                        "arousal": 0.7,
                        "speaker": "participant",
                        "emotion": "å–œã³:0.9 æœŸå¾…:0.1",
                        "start": 19000,
                        "end": 22800,
                        "total_score": 88.5,
                        "avg_score": 1.85,
                        "file_id": "2301092100",
                        "text": "ä»Šæ—¥ã¯ã¨ã¦ã‚‚è‰¯ã„å¤©æ°—ã§ã™ã­ï¼æ°—æŒã¡ãŒã„ã„ã§ã™ã€‚æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚å§‹ã¾ã£ã¦æ¥½ã—ã¿ã§ã™ã€‚é ‘å¼µã£ã¦æˆåŠŸã•ã›ãŸã„ã¨æ€ã„ã¾ã™ã€‚",
                        "stress_score_avg": 1.8,
                        "audio_emotion": "angry:0.0 happy:0.9 sad:0.05 neutral:0.05",
                        "face_emotion": "anger:0.02 disgust:0.01 fear:0.02 happiness:0.92 sadness:0.01 surprise:0.02 neutral:0.0",
                        "pitch_roll_yaw": "Pitch:8.5 Roll:-1.2 Yaw:2.3",
                        "AU": "AU01:0.2 AU02:0.1 AU04:0.0 AU05:0.15 AU06:0.95 AU07:0.0 AU09:0.0 AU10:0.05 AU11:0.0 AU12:0.98 AU14:0.1 AU15:0.0 AU17:0.0 AU20:0.1 AU23:0.0 AU24:0.0 AU25:0.2 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": 0.1,
                        "arousal": 0.2,
                        "speaker": "counselor",
                        "emotion": "å¹³é™:0.9",
                        "start": 23000,
                        "end": 26200,
                        "total_score": null,
                        "avg_score": null,
                        "file_id": "2301092100",
                        "text": "ãã†ã§ã™ã­ã€æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹ã¨ãã®æ°—æŒã¡ã¯ã©ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã‹ï¼ŸæœŸå¾…ã¨ä¸å®‰ãŒæ··ã˜ã£ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã­ã€‚",
                        "stress_score_avg": null,
                        "audio_emotion": "angry:0.0 happy:0.3 sad:0.1 neutral:0.6",
                        "face_emotion": "anger:0.01 disgust:0.01 fear:0.05 happiness:0.25 sadness:0.05 surprise:0.03 neutral:0.6",
                        "pitch_roll_yaw": "Pitch:1.8 Roll:0.2 Yaw:-1.1",
                        "AU": "AU01:0.1 AU02:0.05 AU04:0.02 AU05:0.0 AU06:0.2 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.3 AU14:0.0 AU15:0.0 AU17:0.0 AU20:0.0 AU23:0.0 AU24:0.0 AU25:0.05 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": -0.3,
                        "arousal": 0.4,
                        "speaker": "participant",
                        "emotion": "æ‚²ã—ã¿:0.6 æã‚Œ:0.4",
                        "start": 26500,
                        "end": 29800,
                        "total_score": 72.3,
                        "avg_score": 2.1,
                        "file_id": "2301092100",
                        "text": "å®Ÿã¯å°‘ã—ä¸å®‰ã‚‚ã‚ã‚Šã¾ã™ã€‚ã†ã¾ãã„ãã‹ã©ã†ã‹å¿ƒé…ã§å¤œã‚‚çœ ã‚Œã¾ã›ã‚“ã€‚å¤±æ•—ã—ãŸã‚‰ã©ã†ã—ã‚ˆã†ã¨æ€ã£ã¦ã—ã¾ã„ã¾ã™ã€‚ã§ã‚‚é ‘å¼µã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚",
                        "stress_score_avg": 3.2,
                        "audio_emotion": "angry:0.1 happy:0.1 sad:0.7 neutral:0.1",
                        "face_emotion": "anger:0.05 disgust:0.02 fear:0.4 happiness:0.1 sadness:0.4 surprise:0.02 neutral:0.01",
                        "pitch_roll_yaw": "Pitch:-2.1 Roll:1.5 Yaw:0.8",
                        "AU": "AU01:0.3 AU02:0.2 AU04:0.6 AU05:0.0 AU06:0.1 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.05 AU14:0.0 AU15:0.4 AU17:0.0 AU20:0.0 AU23:0.2 AU24:0.0 AU25:0.0 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": 0.3,
                        "arousal": 0.1,
                        "speaker": "counselor",
                        "emotion": "å¹³é™:0.8",
                        "start": 30000,
                        "end": 33500,
                        "total_score": null,
                        "avg_score": null,
                        "file_id": "2301092100",
                        "text": "ä¸å®‰ã‚’æ„Ÿã˜ã‚‹ã®ã¯è‡ªç„¶ãªã“ã¨ã§ã™ã­ã€‚ä¸€æ­©ãšã¤é€²ã‚“ã§ã„ã‘ã°å¤§ä¸ˆå¤«ã§ã™ã‚ˆã€‚å®Œç’§ã‚’æ±‚ã‚ã™ããšã«ã€ã¾ãšã¯å°ã•ãªç›®æ¨™ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚",
                        "stress_score_avg": null,
                        "audio_emotion": "angry:0.0 happy:0.4 sad:0.0 neutral:0.6",
                        "face_emotion": "anger:0.01 disgust:0.01 fear:0.02 happiness:0.35 sadness:0.02 surprise:0.01 neutral:0.58",
                        "pitch_roll_yaw": "Pitch:3.2 Roll:-0.8 Yaw:-0.5",
                        "AU": "AU01:0.05 AU02:0.03 AU04:0.0 AU05:0.0 AU06:0.25 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.4 AU14:0.0 AU15:0.0 AU17:0.0 AU20:0.0 AU23:0.0 AU24:0.0 AU25:0.05 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": 0.4,
                        "arousal": 0.5,
                        "speaker": "participant",
                        "emotion": "å¸Œæœ›:0.7 å®‰å¿ƒ:0.3",
                        "start": 34000,
                        "end": 37200,
                        "total_score": 85.2,
                        "avg_score": 1.9,
                        "file_id": "2301092100",
                        "text": "ãã†ã§ã™ã­ã€å°ã•ãªç›®æ¨™ã‹ã‚‰å§‹ã‚ã‚‹ã®ã¯è‰¯ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã™ã­ã€‚å°‘ã—ãšã¤å‰é€²ã—ã¦ã„ã‘ã°é”æˆæ„Ÿã‚‚å‘³ã‚ãˆãã†ã§ã™ã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚",
                        "stress_score_avg": 2.1,
                        "audio_emotion": "angry:0.0 happy:0.7 sad:0.1 neutral:0.2",
                        "face_emotion": "anger:0.01 disgust:0.01 fear:0.05 happiness:0.7 sadness:0.05 surprise:0.03 neutral:0.15",
                        "pitch_roll_yaw": "Pitch:4.1 Roll:-0.5 Yaw:1.2",
                        "AU": "AU01:0.1 AU02:0.05 AU04:0.0 AU05:0.05 AU06:0.6 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.75 AU14:0.0 AU15:0.0 AU17:0.0 AU20:0.0 AU23:0.0 AU24:0.0 AU25:0.1 AU26:0.0 AU28:0.0 AU43:0.0"
                    },
                    {
                        "valence": -0.1,
                        "arousal": 0.3,
                        "speaker": "participant",
                        "emotion": "ç–²ã‚Œ:0.8 æ†‚é¬±:0.2",
                        "start": 38000,
                        "end": 41500,
                        "total_score": 70.5,
                        "avg_score": 2.3,
                        "file_id": "2301092100",
                        "text": "æœ€è¿‘ã¯ä»•äº‹ã§ç–²ã‚Œã‚‹ã“ã¨ãŒå¤šãã¦ã€å®¶ã«å¸°ã£ã¦ã‚‚ãªã‹ãªã‹ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã¾ã›ã‚“ã€‚ä¼‘æ—¥ã‚‚ä½•ã¨ãªãæ°—åˆ†ãŒé‡ã„ã§ã™ã€‚",
                        "stress_score_avg": 3.5,
                        "audio_emotion": "angry:0.05 happy:0.1 sad:0.8 neutral:0.05",
                        "face_emotion": "anger:0.02 disgust:0.03 fear:0.1 happiness:0.05 sadness:0.75 surprise:0.02 neutral:0.03",
                        "pitch_roll_yaw": "Pitch:-1.5 Roll:0.8 Yaw:-0.3",
                        "AU": "AU01:0.2 AU02:0.1 AU04:0.3 AU05:0.0 AU06:0.05 AU07:0.0 AU09:0.0 AU10:0.0 AU11:0.0 AU12:0.02 AU14:0.0 AU15:0.6 AU17:0.0 AU20:0.0 AU23:0.1 AU24:0.0 AU25:0.0 AU26:0.0 AU28:0.0 AU43:0.0"
                    }
                ]
            };
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:', sampleData);
            loadData(sampleData);
        }

        // å½¢æ…‹ç´ è§£æã®åˆæœŸåŒ–
        function initializeMorphology() {
            console.log('=== å½¢æ…‹ç´ è§£æåˆæœŸåŒ–é–‹å§‹ ===');
            
            if (typeof kuromoji === 'undefined') {
                console.error('kuromoji.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                updateMorphologyStatus('error', 'âŒ å½¢æ…‹ç´ è§£æ: ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—');
                return;
            }
            
            updateMorphologyStatus('loading', 'ğŸ”„ å½¢æ…‹ç´ è§£æ: è¾æ›¸èª­ã¿è¾¼ã¿ä¸­...');
            
            try {
                const dicPath = 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/';
                
                kuromoji.builder({ dicPath: dicPath }).build(function (err, tokenizer) {
                    if (err) {
                        console.error('å½¢æ…‹ç´ è§£æã®åˆæœŸåŒ–ã«å¤±æ•—:', err);
                        updateMorphologyStatus('error', 'âŒ å½¢æ…‹ç´ è§£æ: è¾æ›¸èª­ã¿è¾¼ã¿å¤±æ•—');
                        enableSimpleMorphology();
                        return;
                    }
                    
                    morphologyTokenizer = tokenizer;
                    updateMorphologyStatus('ready', 'âœ… å½¢æ…‹ç´ è§£æ: åˆ©ç”¨å¯èƒ½');
                    console.log('å½¢æ…‹ç´ è§£æã®åˆæœŸåŒ–å®Œäº†');
                });
            } catch (error) {
                console.error('å½¢æ…‹ç´ è§£æåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                updateMorphologyStatus('error', 'âŒ å½¢æ…‹ç´ è§£æ: åˆæœŸåŒ–å¤±æ•—');
                enableSimpleMorphology();
            }
        }

        function enableSimpleMorphology() {
            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: è»½é‡åˆ†ã‹ã¡æ›¸ãã‚’ä½¿ç”¨');
            updateMorphologyStatus('ready', 'âš ï¸ ç°¡æ˜“åˆ†ã‹ã¡æ›¸ã: åˆ©ç”¨å¯èƒ½');
            morphologyTokenizer = 'simple';
        }

        function simpleTokenize(text) {
            if (!text) return [];
            
            let tokens = [];
            const patterns = [
                /[ä¸€-é¾¯]+[ã-ã‚“]+/g,
                /[ä¸€-é¾¯]+/g,
                /[ã‚¡-ãƒ¶ãƒ¼]+/g,
                /[ã-ã‚“]{2,}/g
            ];
            
            let processedText = text;
            
            patterns.forEach(pattern => {
                const matches = processedText.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        if (match.length >= 2 && !japaneseStopwords.has(match)) {
                            tokens.push({
                                surface_form: match,
                                basic_form: match,
                                pos: 'åè©'
                            });
                        }
                        processedText = processedText.replace(match, '');
                    });
                }
            });
            
            return tokens;
        }

        function updateMorphologyStatus(status, message) {
            const statusElement = document.getElementById('morphologyStatus');
            statusElement.textContent = message;
            statusElement.className = `morphology-status ${status}`;
        }

        function toggleMorphology() {
            console.log('å½¢æ…‹ç´ è§£æåˆ‡ã‚Šæ›¿ãˆé–‹å§‹');
            console.log('useMorphologyç¾åœ¨å€¤:', useMorphology);
            console.log('morphologyTokenizerçŠ¶æ…‹:', morphologyTokenizer);
            
            if (!morphologyTokenizer) {
                alert('å½¢æ…‹ç´ è§£æãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
                return;
            }
            
            useMorphology = !useMorphology;
            const toggleBtn = document.getElementById('morphologyToggle');
            
            if (useMorphology) {
                toggleBtn.textContent = 'å½¢æ…‹ç´ è§£æ: ON';
                toggleBtn.classList.add('active');
            } else {
                toggleBtn.textContent = 'å½¢æ…‹ç´ è§£æ: OFF';
                toggleBtn.classList.remove('active');
            }
            
            console.log('å½¢æ…‹ç´ è§£æåˆ‡ã‚Šæ›¿ãˆå¾Œ:', useMorphology);
            
            if (currentData && segments && segments.length > 0) {
                console.log('é »å‡ºèªåˆ†æã‚’å†å®Ÿè¡Œã—ã¾ã™');
                analyzeWordFrequency();
            }
        }

        function extractWordsWithMorphology(text) {
            if (!text) return [];
            
            try {
                let tokens;
                
                if (morphologyTokenizer === 'simple') {
                    tokens = simpleTokenize(text);
                } else if (morphologyTokenizer && typeof morphologyTokenizer.tokenize === 'function') {
                    tokens = morphologyTokenizer.tokenize(text);
                } else {
                    console.warn('å½¢æ…‹ç´ è§£æå™¨ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                    return extractWords(text);
                }
                
                const words = tokens
                    .filter(token => {
                        const pos = token.pos || 'åè©';
                        const surface = token.surface_form || '';
                        const basic = token.basic_form || token.surface_form || '';
                        
                        return (pos === 'åè©' || pos === 'å‹•è©' || pos === 'å½¢å®¹è©' || pos === 'å‰¯è©') &&
                               surface.length >= 2 &&
                               !japaneseStopwords.has(surface) &&
                               !japaneseStopwords.has(basic) &&
                               !/^[ã-ã‚“ãƒ¼]+$/.test(surface);
                    })
                    .map(token => {
                        const basic = token.basic_form;
                        const surface = token.surface_form;
                        return basic && basic !== '*' && basic !== surface ? basic : surface;
                    })
                    .filter(word => word && word.length >= 2);
                
                return [...new Set(words)];
            } catch (error) {
                console.error('å½¢æ…‹ç´ è§£æã‚¨ãƒ©ãƒ¼:', error);
                return extractWords(text);
            }
        }

        function extractWords(text) {
            if (!text) {
                console.log('extractWords: ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™');
                return [];
            }
            
            console.log('extractWords å‡¦ç†ä¸­:', text.substring(0, 50));
            
            let cleanText = text
                .replace(/[ã€‚ã€ï¼ï¼Ÿ.,!?()ï¼ˆï¼‰ã€Œã€ã€ã€ã€ã€‘]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
            
            let words = [];
            const matches = cleanText.match(/[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾¯]+/g);
            if (matches) {
                words = matches.filter(word => 
                    word.length >= 2 && 
                    !japaneseStopwords.has(word) &&
                    !/^[ã-ã‚“ãƒ¼]+$/.test(word)
                );
            }
            
            console.log('extractWords çµæœ:', words);
            return words;
        }

        function analyzeWordFrequency() {
            console.log('=== é »å‡ºèªåˆ†æé–‹å§‹ï¼ˆå‚åŠ è€…ã®ã¿ï¼‰===');
            console.log('å½¢æ…‹ç´ è§£æä½¿ç”¨:', useMorphology);
            
            // ã¾ãšå¤‰æ•°ãŒæ­£ã—ãåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (typeof useMorphology === 'undefined') {
                console.warn('useMorphology ãŒæœªå®šç¾©ã§ã™ã€‚åˆæœŸåŒ–ä¸­...');
                useMorphology = false;
            }
            
            wordFrequencyData = {};
            
            // å‚åŠ è€…ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿ã‚’å‡¦ç†
            const participantSegments = segments.filter(s => s.speaker === 'participant');
            
            participantSegments.forEach((segment, index) => {
                if (!segment.text || segment.valence === null || segment.arousal === null) {
                    console.log(`å‚åŠ è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ${index} ã‚’ã‚¹ã‚­ãƒƒãƒ—: ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿ãªã—`);
                    return;
                }
                
                console.log(`å‚åŠ è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ ${index} å‡¦ç†ä¸­: "${segment.text.substring(0, 30)}..."`);
                
                const words = useMorphology && morphologyTokenizer ? 
                              extractWordsWithMorphology(segment.text) : 
                              extractWords(segment.text);
                
                console.log(`æŠ½å‡ºã•ã‚ŒãŸå˜èª (${words.length}å€‹):`, words);
                
                words.forEach(word => {
                    if (!wordFrequencyData[word]) {
                        wordFrequencyData[word] = {
                            count: 0,
                            valenceSum: 0,
                            arousalSum: 0,
                            segments: []
                        };
                    }
                    
                    wordFrequencyData[word].count++;
                    wordFrequencyData[word].valenceSum += segment.valence;
                    wordFrequencyData[word].arousalSum += segment.arousal;
                    wordFrequencyData[word].segments.push(segment);
                });
            });
            
            // å¹³å‡å€¤ã‚’è¨ˆç®—
            Object.keys(wordFrequencyData).forEach(word => {
                const data = wordFrequencyData[word];
                data.avgValence = data.valenceSum / data.count;
                data.avgArousal = data.arousalSum / data.count;
            });
            
            console.log('é »å‡ºèªåˆ†æå®Œäº†:', wordFrequencyData);
            console.log('æŠ½å‡ºå˜èªæ•°:', Object.keys(wordFrequencyData).length);
            
            updateWordAnalysis();
        }

        function updateWordAnalysis() {
            console.log('=== é »å‡ºèªåˆ†æè¡¨ç¤ºæ›´æ–°ï¼ˆå‚åŠ è€…ã®ã¿ï¼‰===');
            
            const wordCount = parseInt(document.getElementById('wordCountInput').value);
            
            console.log('å˜èªãƒ‡ãƒ¼ã‚¿:', wordFrequencyData);
            console.log('å˜èªæ•°:', Object.keys(wordFrequencyData).length);
            
            if (!wordFrequencyData || Object.keys(wordFrequencyData).length === 0) {
                console.warn('è¡¨ç¤ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                const plotContainer = document.getElementById('russellWordPlot');
                plotContainer.innerHTML = `
                    <div class="russell-axis horizontal"></div>
                    <div class="russell-axis vertical"></div>
                    <div class="russell-labels" style="top: 10px; left: 50%; transform: translateX(-50%);">é«˜è¦šé†’</div>
                    <div class="russell-labels" style="bottom: 10px; left: 50%; transform: translateX(-50%);">ä½è¦šé†’</div>
                    <div class="russell-labels" style="left: 10px; top: 50%; transform: translateY(-50%);">ä¸å¿«</div>
                    <div class="russell-labels" style="right: 10px; top: 50%; transform: translateY(-50%);">å¿«</div>
                    <div class="no-data" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                        å‚åŠ è€…ã®åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“<br>
                        <small>å½¢æ…‹ç´ è§£æã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>
                    </div>
                `;
                
                // è±¡é™ã‚‚ç©ºã«ã™ã‚‹
                ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                    document.getElementById(q + 'Words').innerHTML = '<span style="color: #999; font-style: italic;">è©²å½“ã™ã‚‹å˜èªãªã—</span>';
                });
                return;
            }
            
            const sortedWords = Object.entries(wordFrequencyData)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, wordCount);
            
            console.log('ã‚½ãƒ¼ãƒˆæ¸ˆã¿å˜èª (ä¸Šä½' + wordCount + 'å€‹):', sortedWords);
            
            updateWordPlot(sortedWords);
            updateQuadrantWords(sortedWords);
        }

        function updateWordPlot(sortedWords) {
            const plotContainer = document.getElementById('russellWordPlot');
            
            const existingWords = plotContainer.querySelectorAll('.word-point');
            existingWords.forEach(word => word.remove());
            
            if (sortedWords.length === 0) {
                return;
            }
            
            const maxCount = Math.max(...sortedWords.map(([, data]) => data.count));
            const minCount = Math.min(...sortedWords.map(([, data]) => data.count));
            
            sortedWords.forEach(([word, data]) => {
                const wordElement = document.createElement('div');
                wordElement.className = 'word-point participant';
                wordElement.textContent = word;
                
                const x = Math.max(5, Math.min(95, ((data.avgValence + 1) / 2) * 90 + 5));
                const y = Math.max(5, Math.min(95, (1 - (data.avgArousal + 1) / 2) * 90 + 5));
                
                wordElement.style.left = x + '%';
                wordElement.style.top = y + '%';
                
                const fontSizeScale = maxCount > minCount ? 
                    0.8 + 0.7 * ((data.count - minCount) / (maxCount - minCount)) : 1;
                wordElement.style.fontSize = (10 * fontSizeScale) + 'px';
                
                wordElement.title = `${word} (${data.count}å›)\nè¦šé†’åº¦: ${data.avgArousal.toFixed(2)}\næ„Ÿæƒ…ä¾¡: ${data.avgValence.toFixed(2)}`;
                
                wordElement.addEventListener('click', () => {
                    showWordDetails(word, data);
                });
                
                plotContainer.appendChild(wordElement);
            });
        }

        function updateQuadrantWords(sortedWords) {
            const quadrants = {
                q1: [],
                q2: [],
                q3: [],
                q4: []
            };
            
            sortedWords.forEach(([word, data]) => {
                const valence = data.avgValence;
                const arousal = data.avgArousal;
                
                if (valence > 0 && arousal > 0) {
                    quadrants.q1.push([word, data]);
                } else if (valence < 0 && arousal > 0) {
                    quadrants.q2.push([word, data]);
                } else if (valence < 0 && arousal < 0) {
                    quadrants.q3.push([word, data]);
                } else if (valence > 0 && arousal < 0) {
                    quadrants.q4.push([word, data]);
                }
            });
            
            Object.keys(quadrants).forEach(quadrant => {
                const container = document.getElementById(quadrant + 'Words');
                if (quadrants[quadrant].length === 0) {
                    container.innerHTML = '<span style="color: #999; font-style: italic;">è©²å½“ã™ã‚‹å˜èªãªã—</span>';
                } else {
                    container.innerHTML = quadrants[quadrant]
                        .slice(0, 10)
                        .map(([word, data]) => `<span class="word-chip">${word} (${data.count})</span>`)
                        .join('');
                }
            });
        }

        function showWordDetails(word, data) {
            let analysisMethod;
            if (useMorphology) {
                analysisMethod = morphologyTokenizer === 'simple' ? 'ç°¡æ˜“åˆ†ã‹ã¡æ›¸ã' : 'å½¢æ…‹ç´ è§£æ(kuromoji)';
            } else {
                analysisMethod = 'æ­£è¦è¡¨ç¾';
            }
            
            const segmentTexts = data.segments.slice(0, 5).map(s => `"${s.text}"`).join('\n');
            const moreSegments = data.segments.length > 5 ? `\n... ä»–${data.segments.length - 5}ä»¶` : '';
            
            alert(`å˜èª: ${word}\nè©±è€…: å‚åŠ è€…\nåˆ†ææ–¹æ³•: ${analysisMethod}\nå‡ºç¾å›æ•°: ${data.count}\nå¹³å‡è¦šé†’åº¦: ${data.avgArousal.toFixed(3)}\nå¹³å‡æ„Ÿæƒ…ä¾¡: ${data.avgValence.toFixed(3)}\n\nå‡ºç¾æ–‡è„ˆï¼ˆæœ€æ–°5ä»¶ï¼‰:\n${segmentTexts}${moreSegments}`);
        }

        // JSONLãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readJSONLFile(file) {
            console.log('=== ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹ ===');
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.trim().split('\n');
                    const validLines = lines.filter(line => line.trim());
                    
                    if (validLines.length === 0) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }
                    
                    const segments = [];
                    validLines.forEach((line, index) => {
                        try {
                            const parsed = JSON.parse(line);
                            segments.push(parsed);
                        } catch (parseError) {
                            console.error(`è¡Œ ${index + 1} ã®è§£æã‚¨ãƒ©ãƒ¼:`, parseError);
                            throw new Error(`è¡Œ ${index + 1} ã®è§£æã«å¤±æ•—: ${parseError.message}`);
                        }
                    });
                    
                    const jsonData = { segments: segments };
                    loadData(jsonData);
                    
                } catch (error) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                    alert('JSONLãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
        function loadData(data) {
            console.log('=== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†é–‹å§‹ ===');
            currentData = data;
            segments = data.segments || [];
            filteredSegments = [...segments];
            segmentMapping = segments.map((_, index) => index);
            currentSegmentIndex = 0;
            
            if (segments.length === 0) {
                alert('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°:', segments.length);
            console.log('ã‚µãƒ³ãƒ—ãƒ«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ:', segments[0]);
            
            updateFileInfo();
            updateStatistics();
            updateRussellCircle();
            updateTrendsChart();
            updateConversationView();
            loadMediaFiles();
            enableControls();
            
            // è¡¨æƒ…åˆ†æãƒ‡ãƒ¼ã‚¿å‡¦ç†
            processFaceAnalysisData();
            
            // é »å‡ºèªåˆ†æã‚’é…å»¶å®Ÿè¡Œ
            console.log('é »å‡ºèªåˆ†æã‚’é–‹å§‹ã—ã¾ã™...');
            setTimeout(() => {
                console.log('useMorphologyçŠ¶æ…‹:', typeof useMorphology, useMorphology);
                console.log('morphologyTokenizerçŠ¶æ…‹:', typeof morphologyTokenizer, morphologyTokenizer);
                analyzeWordFrequency();
            }, 500);
            
            console.log('=== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†å®Œäº† ===');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±æ›´æ–°
        function updateFileInfo() {
            const firstSegment = segments[0];
            const fileId = firstSegment?.file_id || 'Unknown';
            
            document.getElementById('fileId').textContent = fileId;
            document.getElementById('segmentCount').textContent = segments.length;
            updateCurrentSegmentInfo();
            
            if (fileId !== 'Unknown') {
                mediaFiles.video = `video/${fileId}.mp4`;
                mediaFiles.audio = getSegmentAudioFile(segments[currentSegmentIndex]);
            }
        }

        // ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæƒ…å ±æ›´æ–°
        function updateCurrentSegmentInfo() {
            if (segments.length > 0 && currentSegmentIndex < segments.length) {
                const segment = segments[currentSegmentIndex];
                const info = `${currentSegmentIndex + 1}/${segments.length} - ${segment.speaker}`;
                document.getElementById('currentSegmentInfo').textContent = info;
            }
        }

        // è¡¨æƒ…ã®å¹³å‡å€¤ã‚’æ±‚ã‚ã¦è¿”ã™
        function calculateAverageFaceEmotion(faceEmotionSegments, emotionType) {
            let avgEmotionValue = 0;
            if (faceEmotionSegments.length > 0) {
                let emotionSum = 0;
                let validCount = 0;

                faceEmotionSegments.forEach(s => {
                    try {
                        const emotions = s.face_emotion.split(' ');
                        emotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion === emotionType && value !== undefined) {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    emotionSum += numValue;
                                    validCount++;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('è¡¨æƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                avgEmotionValue = validCount > 0 ? emotionSum / validCount : 0;
                return avgEmotionValue;
           }  
           return 0.0;

        }

        // éŸ³å£°æ„Ÿæƒ…ã®å¹³å‡å€¤ã‚’æ±‚ã‚ã¦è¿”ã™
        function calculateAverageAudioEmotion(audioEmotionSegments, emotionType) {
            let avgEmotionValue = 0;
            if (audioEmotionSegments.length > 0) {
                let emotionSum = 0;
                let validCount = 0;

                audioEmotionSegments.forEach(s => {
                    try {
                        const emotions = s.audio_emotion.split(' ');
                        emotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion === emotionType && value !== undefined) {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    emotionSum += numValue;
                                    validCount++;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('éŸ³å£°æ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                avgEmotionValue = validCount > 0 ? emotionSum / validCount : 0;
                return avgEmotionValue;
           }  
           return 0.0;

        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ã®å¹³å‡å€¤ã‚’æ±‚ã‚ã¦è¿”ã™
        function calculateAverageTextEmotion(textEmotionSegments, emotionType) {
            let avgEmotionValue = 0;
            if (textEmotionSegments.length > 0) {
                let emotionSum = 0;
                let validCount = 0;

                textEmotionSegments.forEach(s => {
                    try {
                        const emotions = s.text_emotion.split(' ');
                        emotions.forEach(emotionStr => {
                            const [emotion, value] = emotionStr.split(':');
                            if (emotion === emotionType && value !== undefined) {
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    emotionSum += numValue;
                                    validCount++;
                                }
                            }
                        });
                    } catch (error) {
                        console.warn('ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                avgEmotionValue = validCount > 0 ? emotionSum / validCount : 0;
                return avgEmotionValue;
           }  
           return 0.0;
        }


        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStatistics() {
            console.log('=== çµ±è¨ˆæƒ…å ±æ›´æ–°é–‹å§‹ ===');
            const participantSegments = segments.filter(s => s.speaker === 'participant' && s.valence !== null);
            console.log('å‚åŠ è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ•°:', participantSegments.length);
            
            if (participantSegments.length === 0) {
                document.getElementById('avgArousal').textContent = '-';
                document.getElementById('avgValence').textContent = '-';
                document.getElementById('avgStress').textContent = '-';
                
                document.getElementById('avgAudioSad').textContent = '-';
                document.getElementById('avgAudioHap').textContent = '-';
                document.getElementById('avgAudioAng').textContent = '-';

                document.getElementById('avgTextSad').textContent = '-';
                document.getElementById('avgTextAnger').textContent = '-';
                document.getElementById('avgTextJoy').textContent = '-';

                document.getElementById('avgFaceSad').textContent = '-';
                document.getElementById('avgFaceHap').textContent = '-';
                document.getElementById('avgFaceAng').textContent = '-';
                return;
            }
            
            const avgArousal = participantSegments.reduce((sum, s) => sum + (s.arousal || 0), 0) / participantSegments.length;
            const avgValence = participantSegments.reduce((sum, s) => sum + (s.valence || 0), 0) / participantSegments.length;
            
            const stressSegments = participantSegments.filter(s => s.stress_score_avg !== null);
            const avgStress = stressSegments.length > 0 ? 
                stressSegments.reduce((sum, s) => sum + s.stress_score_avg, 0) / stressSegments.length : 0;
            
            // ãƒ†ã‚­ã‚¹ãƒˆæ„Ÿæƒ…ã®æ‚²ã—ã¿å¹³å‡ã‚’è¨ˆç®—
            const textSegments = participantSegments.filter(s => s.text_emotion);
            let avgTextSad = calculateAverageTextEmotion(textSegments, 'sadness');
            let avgTextAnger = calculateAverageTextEmotion(textSegments, 'anger');
            let avgTextJoy = calculateAverageTextEmotion(textSegments, 'joy');

            // éŸ³å£°æ„Ÿæƒ…ã®æ‚²ã—ã¿å¹³å‡ã‚’è¨ˆç®—
            const audioSegments = participantSegments.filter(s => s.audio_emotion);
            let avgAudioSadness = calculateAverageAudioEmotion(audioSegments, 'sad');            
            let avgAudioHappiness = calculateAverageAudioEmotion(audioSegments, 'happy');
            let avgAudioAnger = calculateAverageAudioEmotion(audioSegments, 'angry');


           
            // è¡¨æƒ…ã®æ‚²ã—ã¿å¹³å‡ã‚’è¨ˆç®—
            const faceSegments = participantSegments.filter(s => s.face_emotion);
            let avgFaceSadness = calculateAverageFaceEmotion(faceSegments, 'sadness');
            let avgFaceHapiness = calculateAverageFaceEmotion(faceSegments, '')
            let avgFaceAnger = calculateAverageFaceEmotion(faceSegments, 'anger');
            
            document.getElementById('avgArousal').textContent = avgArousal.toFixed(2);
            document.getElementById('avgValence').textContent = avgValence.toFixed(2);
            document.getElementById('avgStress').textContent = avgStress.toFixed(1);

            document.getElementById('avgAudioSad').textContent = avgAudioSadness.toFixed(4);
            document.getElementById('avgAudioHap').textContent = avgAudioHappiness.toFixed(4);
            document.getElementById('avgAudioAng').textContent = avgAudioAnger.toFixed(4);

            document.getElementById('avgFaceSad').textContent = avgFaceSadness.toFixed(4);
            document.getElementById('avgFaceHap').textContent = avgFaceHapiness.toFixed(4);
            document.getElementById('avgFaceAnger').textContent = avgFaceAnger.toFixed(4);

            document.getElementById('avgTextSad').textContent = avgTextSad.toFixed(4);
            document.getElementById('avgTextJoy').textContent = avgTextJoy.toFixed(4);
            document.getElementById('avgTextAnger').textContent = avgTextAnger.toFixed(4);
            

            console.log('çµ±è¨ˆæƒ…å ±:', { avgArousal, avgValence, avgStress, avgTextJoy, avgTextAnger, avgTextSad, avgAudioHappiness, avgAudioAnger, avgFaceSadness, avgFaceHapiness, avgFaceAnger });
        }

        // æ„Ÿæƒ…ã®è‰²ã‚’å–å¾—
        function getEmotionColor(emotion) {
            if (!emotion) return '#74b9ff';
            
            const emotionMap = {
                'å¹³é™': '#6c5ce7',
                'å¹¸ç¦': '#00b894',
                'æ˜ã‚‹ã„': '#fdcb6e',
                'èˆˆå¥®': '#fd79a8',
                'é©šã': '#e17055',
                'è­¦æˆ’': '#74b9ff',
                'æã‚Œ': '#a29bfe',
                'æ‚©ã¿': '#8884d8',
                'ä¸æ„‰å¿«': '#d63031',
                'æŠ‘åœ§': '#636e72',
                'æ†‚é¬±': '#2d3436',
                'é€€å±ˆ': '#b2bec3',
                'ç–²ã‚Œ': '#fab1a0',
                'çœ æ°—': '#81ecec',
                'ãƒªãƒ©ãƒƒã‚¯ã‚¹': '#55a3ff',
                'æ°—æ¥½': '#00cec9',
                'æº€è¶³': '#6c5ce7'
            };
            
            const emotionName = emotion.split(':')[0];
            return emotionMap[emotionName] || '#74b9ff';
        }

        // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateTrendsChart() {
            console.log('=== ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°é–‹å§‹ ===');
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const participantData = segments.filter(s => s.speaker === 'participant');
            const timeLabels = participantData.map((s, i) => `${i + 1}`);
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'è¦šé†’åº¦',
                            data: participantData.map(s => s.arousal),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            pointBackgroundColor: '#ff6b6b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'æ„Ÿæƒ…ä¾¡',
                            data: participantData.map(s => s.valence),
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4,
                            pointBackgroundColor: '#4ecdc4',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'ã‚¹ãƒˆãƒ¬ã‚¹',
                            data: participantData.map(s => s.stress_score_avg ? s.stress_score_avg / 5 : null),
                            borderColor: '#feca57',
                            backgroundColor: 'rgba(254, 202, 87, 0.1)',
                            tension: 0.4,
                            pointBackgroundColor: '#feca57',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    },
                    onHover: (event, activeElements) => {
                        event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                    },
                    onClick: (event, activeElements) => {
                        if (activeElements.length > 0) {
                            const index = activeElements[0].index;
                            const participantSegmentIndex = getParticipantSegmentIndex(index);
                            if (participantSegmentIndex !== -1) {
                                jumpToSegment(participantSegmentIndex);
                            }
                        }
                    }
                }
            });
            
            console.log('ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆä½œæˆå®Œäº†');
        }

        // å‚åŠ è€…ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
        function getParticipantSegmentIndex(participantIndex) {
            let count = 0;
            for (let i = 0; i < segments.length; i++) {
                if (segments[i].speaker === 'participant') {
                    if (count === participantIndex) {
                        return i;
                    }
                    count++;
                }
            }
            return -1;
        }

        // Russellå††ç’°ãƒ¢ãƒ‡ãƒ«æ›´æ–°
        function updateRussellCircle() {
            console.log('=== Russellå††ç’°ãƒ¢ãƒ‡ãƒ«æ›´æ–°é–‹å§‹ ===');
            const circle = document.getElementById('russellCircle');
            
            const existingPoints = circle.querySelectorAll('.russell-point');
            existingPoints.forEach(point => point.remove());
            
            segments.forEach((segment, index) => {
                if (segment.valence !== null && segment.arousal !== null) {
                    const point = document.createElement('div');
                    point.className = `russell-point ${segment.speaker}`;
                    point.dataset.segmentIndex = index;
                    
                    const x = ((segment.valence + 1) / 2) * 100;
                    const y = (1 - (segment.arousal + 1) / 2) * 100;
                    
                    point.style.left = x + '%';
                    point.style.top = y + '%';
                    point.title = `${segment.speaker}: ${segment.text?.substring(0, 50)}...`;
                    
                    point.addEventListener('click', () => {
                        jumpToSegment(index);
                    });
                    
                    circle.appendChild(point);
                }
            });
            
            console.log('Russellå††ç’°ãƒã‚¤ãƒ³ãƒˆæ•°:', circle.querySelectorAll('.russell-point').length);
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã‚¸ãƒ£ãƒ³ãƒ—
        function jumpToSegment(segmentIndex) {
            console.log('=== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚¸ãƒ£ãƒ³ãƒ— ===', segmentIndex);
            
            // å…¨ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º
            resetFilters();
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’é¸æŠã—ã¦å†ç”Ÿ
            selectAndPlaySegment(segmentIndex);
            
            // ä¼šè©±ãƒ“ãƒ¥ãƒ¼ã§è©²å½“ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                const messages = document.querySelectorAll('.message');
                if (messages[segmentIndex]) {
                    messages[segmentIndex].scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }
            }, 100);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetFilters() {
            document.getElementById('speakerFilter').value = '';
            document.getElementById('emotionFilter').value = '';
            document.getElementById('keywordSearch').value = '';
            applyFilters();
        }

        // ä¼šè©±ãƒ“ãƒ¥ãƒ¼æ›´æ–°
        function updateConversationView() {
            console.log('=== ä¼šè©±ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–‹å§‹ ===');
            const conversationView = document.getElementById('conversationView');
            
            if (filteredSegments.length === 0) {
                conversationView.innerHTML = '<div class="no-data">è¡¨ç¤ºã™ã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const conversationHtml = filteredSegments.map((segment, filteredIndex) => {
                const actualIndex = segmentMapping[filteredIndex];
                const emotion = segment.emotion ? segment.emotion.split(' ')[0].split(':')[0] : '';
                const time = formatTimeFromMs(segment.start);
                
                return `
                    <div class="message ${segment.speaker}" onclick="selectAndPlaySegment(${actualIndex})" style="cursor: pointer;">
                        <div class="message-avatar">
                            ${segment.speaker === 'participant' ? 'P' : 'C'}
                        </div>
                        <div class="message-content">
                            <div class="message-text">${highlightKeyword(segment.text || '')}</div>
                            <div class="message-meta">
                                <span class="message-time">${time}</span>
                                <div class="message-scores">
                                    ${emotion ? `<span class="score-chip" style="background-color: ${getEmotionColor(emotion)}; color: white;">${emotion}</span>` : ''}
                                    ${segment.valence !== null ? `<span class="score-chip">V:${segment.valence.toFixed(2)}</span>` : ''}
                                    ${segment.arousal !== null ? `<span class="score-chip">A:${segment.arousal.toFixed(2)}</span>` : ''}
                                    ${segment.stress_score_avg !== null ? `<span class="score-chip">S:${segment.stress_score_avg.toFixed(1)}</span>` : ''}
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 11px; opacity: 0.8;">
                                <span style="background: rgba(255,255,255,0.3); padding: 2px 6px; border-radius: 10px;">
                                    ğŸµ ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†ç”Ÿ
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            conversationView.innerHTML = conversationHtml;
            console.log('ä¼šè©±ãƒ“ãƒ¥ãƒ¼æ›´æ–°å®Œäº†:', filteredSegments.length, 'ä»¶');
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠã¨å†ç”Ÿ
        function selectAndPlaySegment(index) {
            console.log('=== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠã¨å†ç”Ÿ ===', index);
            if (index < 0 || index >= segments.length) return;
            
            // ç¾åœ¨ã®å†ç”Ÿã‚’åœæ­¢
            stopPlayback();
            
            const segment = segments[index];
            currentSegmentIndex = index;
            updateCurrentSegmentInfo();
            selectSegment(index);
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢å†ç”Ÿ
            playSegment(segment);
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ
        function playSegment(segment) {
            console.log('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ:', segment);
            
            if (currentMediaMode === 'video') {
                playVideoSegment(segment);
            } else {
                playAudioSegment(segment);
            }
        }

        // å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ
        function playVideoSegment(segment) {
            console.log('å‹•ç”»ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ:', segment);
            if (!currentVideoElement) {
                alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            const startTime = segment.start / 1000;
            const endTime = segment.end / 1000;
            
            currentVideoElement.currentTime = startTime;
            
            currentVideoElement.play().then(() => {
                isPlaying = true;
                document.getElementById('playPauseBtn').textContent = 'â¸ï¸ åœæ­¢';
                
                const duration = endTime - startTime;
                if (segmentPlaybackTimeout) {
                    clearTimeout(segmentPlaybackTimeout);
                }
                segmentPlaybackTimeout = setTimeout(() => {
                    currentVideoElement.pause();
                    isPlaying = false;
                    document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ å†ç”Ÿ';
                }, duration * 1000);
            }).catch(err => {
                console.error('å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);
                alert('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // éŸ³å£°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ
        function playAudioSegment(segment) {
            console.log('éŸ³å£°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†ç”Ÿ:', segment);
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå°‚ç”¨ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            const audioFile = getSegmentAudioFile(segment);
            const audioElement = document.createElement('audio');
            audioElement.src = audioFile;
            audioElement.controls = true;
            audioElement.preload = 'metadata';
            
            // ç¾åœ¨ã®éŸ³å£°è¦ç´ ã‚’æ›´æ–°
            if (currentAudioElement && currentAudioElement.parentNode) {
                currentAudioElement.parentNode.replaceChild(audioElement, currentAudioElement);
            }
            currentAudioElement = audioElement;
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            audioElement.addEventListener('loadedmetadata', function() {
                audioElement.play().then(() => {
                    isPlaying = true;
                    document.getElementById('playPauseBtn').textContent = 'â¸ï¸ åœæ­¢';
                }).catch(err => {
                    console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);
                    alert(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${audioFile}ã€ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ`);
                });
            });
            
            audioElement.addEventListener('ended', function() {
                isPlaying = false;
                document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ å†ç”Ÿ';
            });
            
            audioElement.addEventListener('error', function() {
                alert(`éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${audioFile}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            });
        }

        // å†ç”Ÿåœæ­¢
        function stopPlayback() {
            if (segmentPlaybackTimeout) {
                clearTimeout(segmentPlaybackTimeout);
                segmentPlaybackTimeout = null;
            }
            
            if (currentVideoElement) {
                currentVideoElement.pause();
            }
            if (currentAudioElement) {
                currentAudioElement.pause();
            }
            
            isPlaying = false;
            document.getElementById('playPauseBtn').textContent = 'â–¶ï¸ å†ç”Ÿ';
        }

        // å†ç”Ÿ/ä¸€æ™‚åœæ­¢åˆ‡ã‚Šæ›¿ãˆ
        function togglePlayPause() {
            if (isPlaying) {
                stopPlayback();
            } else {
                if (currentSegmentIndex < segments.length) {
                    playSegment(segments[currentSegmentIndex]);
                }
            }
        }

        // å‰ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ç§»å‹•
        function previousSegment() {
            if (currentSegmentIndex > 0) {
                selectAndPlaySegment(currentSegmentIndex - 1);
            }
        }

        // æ¬¡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ç§»å‹•
        function nextSegment() {
            if (currentSegmentIndex < segments.length - 1) {
                selectAndPlaySegment(currentSegmentIndex + 1);
            }
        }

        // ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å†ç”Ÿ
        function playCurrentSegment() {
            if (currentSegmentIndex < segments.length) {
                selectAndPlaySegment(currentSegmentIndex);
            }
        }

        // æ™‚é–“è¡¨ç¤ºæ›´æ–°
        function updateTimeDisplay() {
            const activeElement = currentMediaMode === 'video' ? currentVideoElement : currentAudioElement;
            if (!activeElement) return;
            
            const currentTime = activeElement.currentTime;
            const duration = activeElement.duration || 0;
            
            document.getElementById('timeDisplay').textContent = 
                `${formatTime(currentTime)} / ${formatTime(duration)}`;
            
            const progressBar = document.getElementById('progressBar');
            if (duration > 0) {
                const progress = (currentTime / duration) * 100;
                progressBar.style.width = progress + '%';
            }
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        function highlightKeyword(text) {
            const keyword = document.getElementById('keywordSearch').value.trim();
            if (!keyword) return text;
            
            const regex = new RegExp(`(${keyword})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function applyFilters() {
            console.log('=== ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–‹å§‹ ===');
            const speakerFilter = document.getElementById('speakerFilter').value;
            const emotionFilter = document.getElementById('emotionFilter').value;
            const keywordFilter = document.getElementById('keywordSearch').value.toLowerCase().trim();
            
            filteredSegments = [];
            segmentMapping = [];
            
            segments.forEach((segment, index) => {
                // è©±è€…ãƒ•ã‚£ãƒ«ã‚¿
                if (speakerFilter && segment.speaker !== speakerFilter) return;
                
                // æ„Ÿæƒ…ãƒ•ã‚£ãƒ«ã‚¿
                if (emotionFilter && (!segment.emotion || !segment.emotion.includes(emotionFilter))) return;
                
                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿
                if (keywordFilter && (!segment.text || !segment.text.toLowerCase().includes(keywordFilter))) return;
                
                filteredSegments.push(segment);
                segmentMapping.push(index);
            });
            
            console.log('ãƒ•ã‚£ãƒ«ã‚¿çµæœ:', filteredSegments.length, '/', segments.length);
            updateConversationView();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            console.log('ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ:', tabName);
            
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // è©±è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setSpeakerFilter(speaker) {
            console.log('è©±è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š:', speaker);
            
            // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.speaker-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            document.querySelector(`[data-speaker="${speaker}"]`).classList.add('active');
            
            currentWordAnalysisSpeaker = speaker;
            
            if (currentData && wordFrequencyData && Object.keys(wordFrequencyData).length > 0) {
                updateWordAnalysis();
            }
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠ
        function selectSegment(index) {
            console.log('ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé¸æŠ:', index);
            if (index < 0 || index >= segments.length) return;
            
            currentSegmentIndex = index;
            updateCurrentSegmentInfo();
            
            // Russellå††ç’°ã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.russell-point').forEach(point => {
                point.classList.remove('active');
                if (parseInt(point.dataset.segmentIndex) === index) {
                    point.classList.add('active');
                }
            });
            
            // ä¼šè©±ãƒ“ãƒ¥ãƒ¼ã§ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.message').forEach(msg => msg.classList.remove('active'));
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ™‚ã¯ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const filteredIndex = segmentMapping.indexOf(index);
            if (filteredIndex !== -1) {
                const messages = document.querySelectorAll('.message');
                if (messages[filteredIndex]) {
                    messages[filteredIndex].classList.add('active');
                }
            }
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatTimeFromMs(milliseconds) {
            const seconds = milliseconds / 1000;
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            const ms = Math.floor((seconds % 1) * 100);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(2, '0')}`;
        }

        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç”¨ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç”Ÿæˆ
        function getSegmentAudioFile(segment) {
            return `audio/${segment.file_id}/${segment.speaker}_${segment.start}_${segment.end}.wav`;
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function loadMediaFiles() {
            console.log('ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿:', currentMediaMode);
            const mediaPlayer = document.getElementById('mediaPlayer');
            
            if (currentMediaMode === 'video') {
                loadVideoOnly();
            } else {
                loadAudioOnly();
            }
        }

        // å‹•ç”»ã®ã¿èª­ã¿è¾¼ã¿
        function loadVideoOnly() {
            const mediaPlayer = document.getElementById('mediaPlayer');
            
            if (!mediaFiles.video) {
                mediaPlayer.innerHTML = '<div class="error-message">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            mediaPlayer.innerHTML = '<div class="loading-indicator">ğŸ“¡ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            const videoElement = document.createElement('video');
            videoElement.src = mediaFiles.video;
            videoElement.controls = true;
            videoElement.preload = 'metadata';
            videoElement.style.width = '100%';
            videoElement.style.maxHeight = '400px';
            
            videoElement.addEventListener('loadstart', function() {
                mediaPlayer.innerHTML = '';
                mediaPlayer.appendChild(videoElement);
            });
            
            videoElement.addEventListener('error', function() {
                mediaPlayer.innerHTML = `<div class="error-message">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${mediaFiles.video}</div>`;
            });
            
            videoElement.addEventListener('timeupdate', updateTimeDisplay);
            
            currentVideoElement = videoElement;
            currentAudioElement = null;
        }

        // éŸ³å£°ã®ã¿èª­ã¿è¾¼ã¿
        function loadAudioOnly() {
            const mediaPlayer = document.getElementById('mediaPlayer');
            
            const currentSegment = segments[currentSegmentIndex];
            const audioFile = getSegmentAudioFile(currentSegment);
            
            mediaPlayer.innerHTML = '<div class="loading-indicator">ğŸ“¡ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
            
            const audioElement = document.createElement('audio');
            audioElement.src = audioFile;
            audioElement.controls = true;
            audioElement.preload = 'metadata';
            audioElement.style.width = '100%';
            audioElement.style.height = '60px';
            
            audioElement.addEventListener('loadstart', function() {
                mediaPlayer.innerHTML = '';
                mediaPlayer.appendChild(audioElement);
            });
            
            audioElement.addEventListener('error', function() {
                mediaPlayer.innerHTML = `<div class="error-message">éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${audioFile}</div>`;
            });
            
            audioElement.addEventListener('timeupdate', updateTimeDisplay);
            
            currentVideoElement = null;
            currentAudioElement = audioElement;
        }

        // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchMediaMode(mode) {
            console.log('ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ:', mode);
            
            // ç¾åœ¨ã®å†ç”Ÿã‚’åœæ­¢
            stopPlayback();
            
            currentMediaMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
            document.getElementById('videoBtn').classList.toggle('active', mode === 'video');
            document.getElementById('audioBtn').classList.toggle('active', mode === 'audio');
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«å†èª­ã¿è¾¼ã¿
            loadMediaFiles();
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ–
        function enableControls() {
            document.getElementById('playPauseBtn').disabled = false;
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
            document.getElementById('playCurrentBtn').disabled = false;
        }

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMèª­ã¿è¾¼ã¿å®Œäº† - åˆæœŸåŒ–é–‹å§‹ ===');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        console.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ:', file.name);
                        readJSONLFile(file);
                    }
                });
            }
            
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const sampleDataBtn = document.getElementById('sampleDataBtn');
            if (sampleDataBtn) {
                sampleDataBtn.addEventListener('click', function() {
                    console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                    loadSampleData();
                });
            }
            
            // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const videoBtn = document.getElementById('videoBtn');
            const audioBtn = document.getElementById('audioBtn');
            
            if (videoBtn) {
                videoBtn.addEventListener('click', function() {
                    switchMediaMode('video');
                });
            }
            
            if (audioBtn) {
                audioBtn.addEventListener('click', function() {
                    switchMediaMode('audio');
                });
            }
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const playCurrentBtn = document.getElementById('playCurrentBtn');
            
            if (playPauseBtn) {
                playPauseBtn.addEventListener('click', togglePlayPause);
            }
            
            if (prevBtn) {
                prevBtn.addEventListener('click', previousSegment);
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', nextSegment);
            }
            
            if (playCurrentBtn) {
                playCurrentBtn.addEventListener('click', playCurrentSegment);
            }
            
            // å½¢æ…‹ç´ è§£æã®åˆæœŸåŒ–
            initializeMorphology();
            
            // é »å‡ºèªåˆ†æã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
            setTimeout(() => {
                console.log('é…å»¶å®Ÿè¡Œ: é »å‡ºèªåˆ†æé–‹å§‹');
                console.log('currentDataå­˜åœ¨:', !!currentData);
                console.log('segmentså­˜åœ¨:', !!segments && segments.length);
                console.log('useMorphologyå®šç¾©æ¸ˆã¿:', typeof useMorphology !== 'undefined', useMorphology);
                
                if (currentData && segments.length > 0) {
                    try {
                        analyzeWordFrequency();
                    } catch (error) {
                        console.error('é »å‡ºèªåˆ†æã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }, 1000);
            
            // å˜èªæ•°å…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const wordCountInput = document.getElementById('wordCountInput');
            if (wordCountInput) {
                wordCountInput.addEventListener('change', function() {
                    if (currentData) updateWordAnalysis();
                });
            }
            
            // å½¢æ…‹ç´ è§£æåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const morphologyToggle = document.getElementById('morphologyToggle');
            if (morphologyToggle) {
                morphologyToggle.addEventListener('click', toggleMorphology);
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('speakerFilter').addEventListener('change', applyFilters);
            document.getElementById('emotionFilter').addEventListener('change', applyFilters);
            document.getElementById('keywordSearch').addEventListener('input', applyFilters);
            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
            document.addEventListener('keydown', function(e) {
                if (!currentData) return;
                
                switch(e.key) {
                    case ' ':
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        previousSegment();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        nextSegment();
                        break;
                    case 'Escape':
                        stopPlayback();
                        break;
                }
            });
            
            console.log('=== åˆæœŸåŒ–å®Œäº† ===');
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
        window.switchTab = switchTab;
        window.selectAndPlaySegment = selectAndPlaySegment;
    </script>
</body>
</html>


